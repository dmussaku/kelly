{% load i18n crm_tags %}
{% load static from staticfiles %}


<div data-js-salescycle='body'
  data-js-salescycle-load-url='{% crm_url "sales_cycle_get_detail" %}'>
  <div class="column-header">

    <div class="column-header-a">

      {% if object %}
        <a href="#">
          <figure class="userpic">
            <img src="{% static 'img/example/userpic6.png' %}" alt="" />
          </figure>
          {{ object.owner.get_billing_user.get_short_name }}
        </a>
        started at {{ first_activity_date|date:'F j, H:i'|default:'Never' }}
      {% endif %}

    </div><div class="column-header-b">
      <div class="dropdown">
        <button type="button" data-toggle="dropdown">Thread codename (dropdown wants to be here)</button>
        <div class="dropdown-menu dropdown-menu--cycles"
          data-js-create-salescycle='dropdown-menu'>
          <div class="dropdown-triangle"></div>
          <div class="dropdown-menu-body">
            <ul class="dropdown-menu-list"
              data-js-salescycle-load='links_container'
            >

              <li class="dropdown-menu-item dropdown-menu-item--newCycle">
                <a class="dropdown-menu-item-link" href="#"
                  data-js-create-salescycle='show_trigger'
                >Create a new cycle</a>


                <form action="{% crm_url 'sales_cycle_create' %}" method="POST"
                  data-js-create-salescycle='form'
                  style='display:none;'> {% csrf_token %}

                  {{ new_sales_cycle_form.title.label }}
                  {{ new_sales_cycle_form.title }}

                  {{ new_sales_cycle_form.products.as_hidden }}
                  {{ new_sales_cycle_form.owner.as_hidden }}
                  {{ new_sales_cycle_form.contact.as_hidden }}
                  {{ new_sales_cycle_form.projected_value.as_hidden }}
                  {{ new_sales_cycle_form.real_value.as_hidden }}

                  <button type="submit" class="btn">Create</button>
                </form>


              </li>

              {% for sc in sales_cycles %}
                <li class="dropdown-menu-item">
                  <a class="dropdown-menu-item-link {% if sc == object %} dropdown-menu-item-link--active {% endif %}" href="#"
                    data-js-salescycle-load-link='{{ sc.id }}'>
                    <div class="column-header-a">
                      <figure class="userpic">
                        <img src="{% static 'img/example/userpic6.png' %}" alt="" />
                      </figure>
                      {{ sc.owner }}
                    </div><div class="column-header-b">
                      {{ sc }}
                    </div><div class="column-header-c">
                      <figure class="userpic"></figure>
                      <figure class="userpic"></figure>
                    </div>
                  </a>
                </li>
              {% endfor %}

            </ul>
          </div>
        </div>
      </div>
    </div><div class="column-header-c">

      {% if object %}
        <div data-js-addmention='visualData'>
          {% for m in mentioned|slice:':3' %}
            <a href="#" class="link-user"><figure class="userpic">
              <img src="{% static 'img/example/userpic1.png' %}" alt=''/>
            </figure></a>
          {% endfor %}
        </div>

        <div class="dropdown">
          <a href="#" class="link-user" data-toggle="dropdown">&hellip; {% if mentioned|length > 3 %} more {{mentioned|length|add:'-3'}} / {% endif %}add</a>

          <form action="{% crm_url 'sales_cycle_add_mention' sales_cycle_pk=object.pk %}" method="POST"
            data-js-addmention='form'> {% csrf_token %}
            <input type="hidden" name='id'/>
          </form>

          <div class="dropdown-menu" style="left:50%;">
            <div class="dropdown-menu-body">
              <ul class="dropdown-menu-list">

                {% if mentioned|length > 3 %}
                  <li class="dropdown-menu-item">other {{mentioned|length|add:'-3'}}: </li>
                {% endif %}
                {% for m in mentioned|slice:'3:' %}
                  <li class="dropdown-menu-item">
                    <a href="#" class="dropdown-menu-item-link">
                      <figure class="userpic">
                        <img src="{% static 'img/example/userpic6.png' %}" alt="" />
                      </figure>
                      {{ m.get_billing_user.get_username }}
                    </a>
                  </li>
                {% endfor %}

                {% for crmuser in crmusers %}
                  {% if not crmuser in mentioned %}
                    <li class="dropdown-menu-item">
                      <a href="#" class="dropdown-menu-item-link"
                        data-js-addmention-id="{{ crmuser.pk }}">
                        <figure class="userpic">
                          <img src="{% static 'img/example/userpic2.png' %}" alt="" />
                        </figure>
                        {{ crmuser.get_billing_user.get_username }}
                      </a>
                    </li>
                  {% endif %}
                {% empty %}
                  <li class="dropdown-menu-item">There is no user to mentioning</li>
                {% endfor %}

              </ul>
            </div>
          </div>
        </div>
      {% endif %}

    </div>
  </div>


  {% if object %}
    <div class="body-column body-column--single">
      <div class="column">
        <div class="line line--borderless">
          <div class="line-aside"></div>
          <div class="line-body line-body--spaceless lineOfLinks line-body--tabs">
            <a href="#" class="lineOfLinks-link active"
              data-js-salescycle-tab-link='addactivity'
            >
              Add activity</a>
            <a href="#" class="lineOfLinks-link"
              data-js-salescycle-tab-link='addproduct'
            >
              Edit product list</a>
            <a href="#" class="lineOfLinks-link"
              data-js-salescycle-tab-link='addvalue'
            >
              Add anticipated value</a>
            <div class="inputLine-caption"
              data-js-salescycle-tab='caption'>
            </div>
          </div>
        </div>
        <div class="line line--borderless">
          <div class="line-aside line-aside--statusForm">
            <figure class="icon">[s]</figure>
          </div>
          <div class="line-body line-body--spaceless">
            <div class="line-body-main">

              <div data-js-salescycle-tab-body='addactivity'
                data-js-salescycle-caption=''>
                <form action="{% crm_url 'activity_create' %}" method="POST"
                  class="statusForm"
                  data-js-addactivity='form'
                > {% csrf_token %}

                  <textarea class="input-text2" rows="3"
                    name='{{ activity_form.title.html_name }}'
                    placeholder="Log your activity..."
                    data-js-addactivity-mention='textarea'
                    data-js-addactivity-mention-data="{{ activity_mentions_json }}"
                    ></textarea>
                  {{ activity_form.mentioned_user_ids_json.as_hidden }}

                  {{ activity_form.description.as_hidden }}
                  {{ activity_form.author.as_hidden }}
                  {{ activity_form.sales_cycle.as_hidden }}

                  <div class="inputLine inputLine--right">
                    <figure class="userpic"></figure>
                    <button type="submit" class="btn">Post</button>
                  </div>
                </form>
              </div>

              <div data-js-salescycle-tab-body='addproduct'
                data-js-salescycle-caption='You can use hashtags to add products from "Add activity" tab.'
                style='display:none;'>

                <form action="{% crm_url 'sales_cycle_remove_product' sales_cycle_pk=object.pk %}" method="POST"
                  data-js-addproduct-remove='form'
                > {% csrf_token %}
                  <input type="hidden" name="product_id"/>
                </form>
                <div class="inputLine">
                  <strong>Current products:</strong>
                </div>
                <div data-js-addproduct='visualContainer'>
                  {% for sc_product in sales_cycle_products %}
                    <a href="#{{ sc_product.pk }}" class="link-product"
                      data-js-addproduct-remove-id="{{ sc_product.pk }}">{{ sc_product.name }}</a>
                  {% endfor %}
                </div>

                <form action="{% crm_url 'sales_cycle_add_product' sales_cycle_pk=object.pk %}" method="POST"
                  class="statusForm"
                  data-js-addproduct='form'
                > {% csrf_token %}

                  <div class="inputLine">
                    <input class="input-text" type="text" placeholder="Enter product"
                      data-js-addproduct='input',
                      data-js-addproduct-products-datum='{{ product_datums }}'/>
                  </div>
                  <br>
                  <br>

                  <input type="hidden" name='product_id'/>

                  <!--
                  <div class="inputLine inputLine--right">
                    <button type="submit" class="btn">Update</button>
                  </div>
                  -->
                </form>
              </div>

              <div data-js-salescycle-tab-body='addvalue'
                data-js-salescycle-caption='What is the value of deal?'
                style='display:none;'>
                <form action="{% crm_url 'sales_cycle_value_update' sales_cycle_pk=object.pk %}" method="POST" class="statusForm"
                  data-js-addvalue='form'
                > {% csrf_token %}

                  <div class="inputLine">
                    <strong>Current value:</strong>
                    <span
                      data-js-addvalue="show-value"
                    >{{ value_form.instance.amount|default:'0' }}</span>
                  </div>
                  <div class="inputLine">
                    <input class="input-text" type="text" placeholder="Update value" name="{{ value_form.amount.html_name }}"
                      data-js-addvalue="input"/>
                    {{ value_form.salary.as_hidden }}
                    {{ value_form.currency.as_hidden }}
                    {{ value_form.owner.as_hidden }}
                  </div>

                  <div class="inputLine inputLine--right">
                    <button type="submit" class="btn">Update</button>
                  </div>
                </form>
              </div>

            </div>
          </div>
        </div>


        {% for activity in activities %}
          {% show_activity activity %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

</div>
